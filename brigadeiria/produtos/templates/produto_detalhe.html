{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>{{ produto.nome }} | Sayuri's Brigadeiros</title>
  <link rel="stylesheet" href="{% static 'CSS/base.css' %}">
  <link rel="stylesheet" href="{% static 'CSS/produto_detalhe.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Voces&display=swap" rel="stylesheet">
</head>
<body>

  <!-- Cabe√ßalho -->
  <header class="produto-header">
    <a href="{% url 'cardapio' %}" class="voltar">‚Üê Voltar ao card√°pio</a>
    <img src="{% static 'src/TCC.png' %}" alt="Logo Sayuri's Brigadeiros" class="logo-header">
  </header>

  <!-- Conte√∫do principal -->
  <main class="produto-container">
    <div class="produto-card">
      {% if produto.imagem %}
        <img src="{{ produto.imagem.url }}" alt="{{ produto.nome }}" class="produto-imagem">
      {% endif %}

      <div class="produto-info">
        <h1 class="produto-nome">{{ produto.nome }}</h1>
        <p class="produto-descricao">{{ produto.descricao }}</p>

        <div class="quantidade-wrapper">
          <button class="btn-quantidade menos">‚àí</button>
          <span class="quantidade" id="quantidade">25</span>
          <button class="btn-quantidade mais">+</button>
        </div>

        <div class="add-wrapper">
          <button class="btn-add" id="btnAdicionar">Adicionar</button>
          <span class="total" id="total">R$ 0,00</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Script de c√°lculo -->
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    const nomeProduto = ("{{ produto.nome }}".trim() || "").toLowerCase();
    const descProduto = ("{{ produto.descricao }}".trim() || "").toLowerCase();

    // Tabela de pre√ßos unit√°rios
    const UNIT = {
      gourmet: 1.50,
      premium: 1.80,
      especial: 2.00
    };

    // Palavras-chave para detec√ß√£o
    const KW = {
      premium: ["premium", "nutella", "4 leites", "pa√ßoca", "crocante"],
      especial: ["especial", "surpresinha", "uva"],
      gourmet: ["gourmet", "ao leite", "cacau", "ninho", "coco", "caf√©"]
    };

    function hasAny(str, arr) {
      return arr.some(k => str.includes(k));
    }

    function detectarCategoria() {
      const contexto = `${nomeProduto} ${descProduto}`;
      if (hasAny(contexto, KW.premium)) return "premium";
      if (hasAny(contexto, KW.especial)) return "especial";
      if (hasAny(contexto, KW.gourmet)) return "gourmet";
      return "gourmet";
    }

    const categoria = detectarCategoria();
    const precoUnitario = UNIT[categoria];

    // Configura√ß√£o do contador
    const minimo = 25;
    const passo = 1;
    let quantidade = minimo;

    const spanQtd = document.getElementById("quantidade");
    const spanTotal = document.getElementById("total");
    const btnMais = document.querySelector(".mais");
    const btnMenos = document.querySelector(".menos");
    const btnAdd = document.getElementById("btnAdicionar");

    function atualizarTotal() {
      const total = quantidade * precoUnitario;
      spanQtd.textContent = quantidade;
      spanTotal.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
    }

    btnMais.addEventListener("click", () => {
      quantidade += passo;
      atualizarTotal();
    });

    btnMenos.addEventListener("click", () => {
      if (quantidade > minimo) {
        quantidade -= passo;
        atualizarTotal();
      }
    });

    btnAdd.addEventListener("click", () => {
      const subtotal = quantidade * precoUnitario;

      // Objeto do produto salvo no carrinho
      const produto = {
        name: "{{ produto.nome }}",
        category: categoria,
        unit_price: precoUnitario,
        quantity: quantidade,
        price: subtotal, // total corrigido
        subtotal: subtotal
      };

      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart.push(produto);
      localStorage.setItem("cart", JSON.stringify(cart));

      alert(`${quantidade} unidades de "${produto.name}" foram adicionadas ao carrinho!`);
    });

    atualizarTotal();
  });
  </script>

  <!-- Rodap√© -->
  <footer class="produto-footer">
    <p>¬© 2025 Sayuri‚Äôs Brigadeiros ‚Äî Feito com üíï e muito chocolate.</p>
  </footer>

  <script>
    window.BUSCAR_URL = "{% url 'buscar' %}";
  </script>
  <script src="{% static 'JS/search.js' %}" defer></script>

</body>
</html>
