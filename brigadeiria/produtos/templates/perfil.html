{% extends "blank.html" %}
{% load static %}

{% block title %}Perfil | Sayuri's Brigaderia{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet">
<link rel="stylesheet" href="{% static 'CSS/base.css' %}">
<link rel="stylesheet" href="{% static 'CSS/perfil.css' %}">

{% if user.is_authenticated %}
    <link rel="stylesheet" href="{% static 'CSS/perfil_logado.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/search.css' %}">
{% else %}
    <link rel="icon" href="{% static 'src/TCC.png' %}" type="image/png">
    <style>
        header, footer { display: none !important; }
    </style>
{% endif %}
{% endblock %}

{% block content %}

{% if user.is_authenticated %}
<!-- ================= HEADER ================= -->
<header class="main-header">
    <div class="container header-grid">
        <a href="{% url 'index' %}" class="brand">
            <img src="{% static 'src/TCC.png' %}" alt="Logo Sayuri's Brigadeiros" class="fotologo">
        </a>

        <div class="search-wrapper">
            <div class="search" id="search">
                <label for="searchInput">
                    <span class="material-symbols-outlined">search</span>
                </label>
                <input class="searchInput" type="search" id="searchInput" placeholder="Pesquisar...">
            </div>
            <div class="results-box" id="resultsBox"></div>
        </div>

        <img src="{% static 'src/ICONS.png' %}" alt="Brigadeiro" class="brigadeiro">
    </div>

    <nav class="menu-opcoes">
        <ul class="container nav-list">
        <li><a href="{% url 'index' %}">P√ÅGINA INICIAL</a></li>
        <li><a href="{% url 'index' %}#sobrenos_slide">SOBRE N√ìS</a></li>
        <li><a href="{% url 'cardapio' %}">CARD√ÅPIO</a></li>
        <li><a href="{% url 'carrinho' %}">CARRINHO</a></li>
        <li><a href="{% url 'perfil' %}">PERFIL</a></li>
        </ul>
    </nav>
</header>
{% endif %}

<!-- ================= CONTAINER CENTRAL ================= -->
<main class="perfil-wrapper">

    {% if messages %}
    <div class="msg-container">
        {% for message in messages %}
        <div class="msg {{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}

    {% if user.is_authenticated %}
    <!-- =========== PERFIL LOGADO =========== -->
    <section class="perfil-logado-box">
        <h2 class="perfil-titulo">Ol√°, {{ user.first_name|default:user.username }} üëã</h2>

        <!-- MODO VISUALIZA√á√ÉO -->
        <div id="viewMode">

            <p class="view-separator">Informa√ß√µes pessoais</p>

            <div class="view-field">
                <label>Nome</label>
                {{ user.first_name }}
            </div>

            <div class="view-field">
                <label>E-mail</label>
                {{ user.email }}
            </div>

            <div class="view-field">
                <label>Telefone</label>
                {{ user.perfil.telefone|default:"N√£o informado" }}
            </div>

            <p class="view-separator">Endere√ßo</p>

            <div class="view-field">
                <label>CEP</label>
                {{ user.perfil.cep|default:"N√£o informado" }}
            </div>

            <div class="view-field">
                <label>Endere√ßo</label>
                {{ user.perfil.endereco|default:"N√£o informado" }}
            </div>

            <div class="view-field">
                <label>N√∫mero</label>
                {{ user.perfil.numero|default:"N√£o informado" }}
            </div>

            <div class="view-field">
                <label>Complemento</label>
                {{ user.perfil.complemento|default:"N√£o informado" }}
            </div>

            <button class="btn-editar" id="btnEditarPerfil">Editar Perfil</button>
        </div>


        <!-- MODO EDI√á√ÉO -->
        <form id="editMode" class="editar-form" action="{% url 'atualizar_perfil' %}" method="POST" style="display:none;">
            {% csrf_token %}
            <p class="end">Informa√ß√µes pessoais</p>
            <input type="text" name="nomeEdit" value="{{ user.first_name }}" placeholder="Nome completo" required>
            <input type="email" name="emailEdit" value="{{ user.email }}" placeholder="E-mail" required>
            <input type="tel" name="telefoneEdit" value="{{ user.perfil.telefone }}" placeholder="Telefone">

            <p class="end">Endere√ßo</p>
            <input type="text" id="cepEdit" name="cepEdit" value="{{ user.perfil.cep }}" placeholder="CEP">
            <input type="text" id="enderecoEdit" name="enderecoEdit" value="{{ user.perfil.endereco }}" placeholder="Endere√ßo">
            <input type="number" id="numberEdit" name="numeroEdit" value="{{ user.perfil.numero }}" placeholder="N√∫mero">
            <input type="text" name="complementoEdit" value="{{ user.perfil.complemento }}" placeholder="Complemento">

            <button type="submit" class="btn-salvar">Salvar</button>
            <button type="button" id="btnCancelarEdicao" class="btn-cancelar">Cancelar</button>
        </form>

        <div class="perfil-acoes">
            <button id="logoutBtn" class="logout-btn">Sair</button>
            <button id="deleteAccountBtn" class="delete-btn">Excluir conta</button>
        </div>
    </section>

    <!-- MODAL LOGOUT -->
    <div id="logoutModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Deseja realmente sair?</h3>
            <div class="modal-actions">
                <a href="{% url 'sair' %}" id="confirmLogout" class="btn-confirm">Sim, sair</a>
                <button id="cancelLogout" class="btn-cancel">N√£o, continuar</button>
            </div>
        </div>
    </div>

    <!-- MODAL EXCLUIR CONTA -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Deseja realmente excluir sua conta?</h3>
            <div class="modal-actions">
                <form action="{% url 'excluir_conta' %}" method="POST">
                    {% csrf_token %}
                    <button type="submit" id="confirmDelete" class="btn-confirm">Sim, excluir</button>
                </form>
                <button id="cancelDelete" class="btn-cancel">N√£o, continuar</button>
            </div>
        </div>
    </div>

    {% else %}
    <!-- ======== TELA DE LOGIN / CADASTRO ======== -->

    <script>
        localStorage.removeItem("cart");
    </script>

    <div class="perfil-container-login">

        <!-- LOGIN -->
        <section class="box-login ativo" id="loginSection">
            <div class="form-content">
                <h3 class="titulo-login">Login</h3>
                <img src="{% static 'src/perfilicon.png' %}" class="icon-profile">

                <form action="{% url 'logar' %}" method="POST">
                    {% csrf_token %}
                    <input type="email" name="email" placeholder="E-mail" required>
                    <input type="password" name="senha" placeholder="Senha" required>
                    <button type="submit">Entrar</button>

                    <p class="texto-mudar">N√£o tem conta?
                        <a href="#" id="btnToRegister">Cadastre-se</a>
                    </p>
                </form>
            </div>
        </section>

        <!-- CADASTRO -->
        <section class="box-register" id="registerSection">
            <div class="form-content">
                <h3 class="titulo-register">Cadastre-se</h3>
                <img src="{% static 'src/perfilicon.png' %}" class="icon-profile">

                <form action="{% url 'registrar' %}" method="POST">
                    {% csrf_token %}
                    <input type="text" name="nome" placeholder="Nome completo" required>
                    <input type="email" name="email" placeholder="E-mail" required>
                    <input type="tel" name="telefone" placeholder="Telefone" required>
                    <input type="password" name="senha" placeholder="Senha" required>
                    <input type="password" name="confirmarSenha" placeholder="Confirmar senha" required>
                    <!-- A mensagem de erro ser√° criada automaticamente ap√≥s o campo confirmarSenha -->


                    <p class="end">Endere√ßo</p>
                    <input type="text" id="cep" name="cep" placeholder="CEP">
                    <input type="text" id="endereco" name="endereco" placeholder="Endere√ßo">
                    <input type="number" id="numero" name="num" placeholder="N√∫mero">
                    <input type="text" name="complemento" placeholder="Complemento">

                    <button type="submit">Cadastrar</button>

                    <p class="texto-mudar">J√° tem conta?
                        <a href="#" id="btnToLogin">Login</a>
                    </p>
                </form>
            </div>
        </section>

    </div>
    {% endif %}
</main>

{% if user.is_authenticated %}
<footer class="main-footer">
    <div class="container footer-grid">
        <div class="footer-logo-esquerda">
            <img src="{% static 'src/TCC.png' %}" class="fotologo1">
        </div>

        <div class="redesSociais">
            <a href="mailto:sayurimo@gmail.com?subject=Contato"><img src="{% static 'src/e-mail.png' %}" class="icones"></a>
            <a href="tel:+5515981453091"><img src="{% static 'src/chamada-telefonica.png' %}" class="icones"></a>
            <a href="https://www.google.com/maps/place/Horto+Florestal+Villagio/@-23.4388829,-47.4939461,17z/data=!4m10!1m2!2m1!1shorto+florestal+villagio!3m6!1s0x94c5f5a1b90c2bf3:0x82d29e5ce04c50a!8m2!3d-23.4388157!4d-47.4913903!15sChhob3J0byBmbG9yZXN0YWwgdmlsbGFnaW-SARNjb25kb21pbml1bV9jb21wbGV44AEA!16s%2Fg%2F11k3w806rl?entry=ttu&g_ep=EgoyMDI1MTEyMy4xIKXMDSoASAFQAw%3D%3D"><img src="{% static 'src/localizacao.png' %}" class="icones"></a>
            <a href="https://www.instagram.com/sayuri_brigadeiros" target="_blank"><img src="{% static 'src/instagram.png' %}" class="icones"></a>
        </div>

        <div class="footer-logo-direita">
            <img src="{% static 'src/Logo Principal.png' %}" class="logo-direita">
        </div>
    </div>
</footer>
{% endif %}

<script src="{% static 'JS/perfil.js' %}"></script>
<script src="{% static 'JS/search.js' %}"></script>
<script src="https://unpkg.com/scrollreveal"></script>

<!-- üî• LIMPAR CARRINHO AO SAIR -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const logout = document.getElementById("logoutBtn");
    if (logout) {
        logout.addEventListener("click", () => {
            localStorage.removeItem("cart");
        });
    }
});
</script>

{% endblock %}
